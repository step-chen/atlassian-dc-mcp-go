# Using Nginx and mkcert for HTTPS Access

This document describes how to configure HTTPS access for the Atlassian DC MCP service using Nginx and mkcert.

## Overview

[mkcert](https://github.com/FiloSottile/mkcert) is a simple tool for local HTTPS development that can create locally trusted development certificates. Combined with Nginx reverse proxy, we can provide HTTPS access for the MCP service.

## Prerequisites

1. Install Docker and Docker Compose
2. Install the mkcert tool

## Installing mkcert

### macOS (using Homebrew)

```bash
brew install mkcert
brew install nss # if using Firefox browser
```

### Linux

#### Ubuntu/Debian (using apt)

On Ubuntu/Debian systems, you can install mkcert directly using apt:

```bash
sudo apt update
sudo apt install mkcert
```

#### Other Linux distributions

On other Linux distributions, you need to install the mkcert binary manually:

```bash
# Download the latest version of mkcert
wget https://github.com/FiloSottile/mkcert/releases/download/v1.4.4/mkcert-v1.4.4-linux-amd64
chmod +x mkcert-v1.4.4-linux-amd64
sudo mv mkcert-v1.4.4-linux-amd64 /usr/local/bin/mkcert
```

## Create Local CA and Generate Certificates

1. Install the local CA:

```bash
mkcert -install
```

This will install the local CA in the system, making all certificates generated by mkcert trusted.

2. Create the certs folder in the project directory:

```bash
mkdir -p ./certs
cd ./certs
```

3. Generate local development certificates:

```bash
mkcert localhost 127.0.0.1 ::1
```

This will generate two files:
- `localhost+2.pem` (certificate file)
- `localhost+2-key.pem` (private key file)

## Configuring Nginx

The project already includes the Nginx configuration file [nginx-config/nginx.conf](nginx-config/nginx.conf), which contains:

1. HTTP to HTTPS redirection
2. SSL certificate configuration
3. Reverse proxy to the MCP service

## Configuration Details

The Nginx configuration in [nginx-config/nginx.conf](file:///home/stephen/workspace/atlassian-dc-mcp-go/nginx-config/nginx.conf) includes specific settings for handling SSE (Server-Sent Events) connections, which are used for streaming responses in the MCP protocol.

### SSE Endpoint Configuration

The `/sse` location block contains specific optimizations for SSE connections:

1. **Buffering disabled**: `proxy_buffering off` and `proxy_cache off` ensure that SSE events are immediately sent to clients without buffering.
2. **Extended timeouts**: `proxy_read_timeout 86400` allows SSE connections to remain open for up to 24 hours.
3. **HTTP/1.1 support**: Required for SSE connections to work properly.
4. **Connection pool optimization**: 
   - `proxy_connect_timeout 5s` - Fast connection establishment
   - `proxy_send_timeout 86400` - Long timeout for SSE streams
   - `keepalive_timeout 86400` - Long keepalive for persistent SSE connections
   - `keepalive_requests 1000` - High number of requests per keepalive connection

### Regular HTTP Endpoint Configuration

The root `/` location block handles regular HTTP requests with different timeout settings:

1. **Standard buffering**: Buffering is enabled for better performance with regular requests.
2. **WebSocket support**: Configuration for upgrading connections to WebSockets.
3. **Connection pool optimization**:
   - `proxy_connect_timeout 5s` - Standard connection timeout
   - `proxy_send_timeout 60s` - Reasonable timeout for regular requests
   - `proxy_read_timeout 60s` - Reasonable timeout for regular requests
   - `keepalive_timeout 65` - Standard keepalive timeout
   - `keepalive_requests 100` - Standard number of requests per keepalive connection

## Starting the Service

Use the following commands to start the service with Nginx:

```bash
# Build and start the service
docker-compose -f docker-compose.nginx.yml up -d

# View logs
docker-compose -f docker-compose.nginx.yml logs -f
```

## Verifying the Configuration

After starting the service, you can access the MCP service through the following URLs:

- HTTPS: https://localhost/sse
- HTTP: http://localhost (will automatically redirect to HTTPS)

## Configuring AI Assistant

When configuring the MCP service in your AI assistant, use the following configuration:

```json
{
  "mcpServers": {
    "atlassian-dc-mcp-sse": {
      "url": "https://localhost/sse",
      "headers": {
        "Jira-Token": "your-jira-api-token",
        "Confluence-Token": "your-confluence-api-token",
        "Bitbucket-Token": "your-bitbucket-api-token"
      }
    }
  }
}
```

## Troubleshooting

### Certificate Not Trusted

If the browser still indicates that the certificate is not trusted, make sure:

1. You have correctly run `mkcert -install`
2. Restart your browser
3. On Linux, you may need to manually install the certificate in the system or browser

### Port Conflicts

If ports 80 or 443 are already in use, you can modify the port mapping in [docker-compose.nginx.yml](docker-compose.nginx.yml):

```yaml
ports:
  - "8080:80"
  - "8443:443"
```

Then access the service via https://localhost:8443.

### Cannot Connect to MCP Service

Check the following:

1. Is the MCP service running correctly: `docker-compose -f docker-compose.nginx.yml logs mcp-server`
2. Is the Nginx configuration correct: `docker-compose -f docker-compose.nginx.yml logs nginx-proxy`
3. Is the network connection normal: Ensure both containers are on the same network

## Production Environment Considerations

This configuration is only suitable for development and testing environments. In production environments, you should:

1. Use valid SSL certificates (such as Let's Encrypt)
2. Configure appropriate firewall rules
3. Strengthen Nginx security configuration
4. Use appropriate load balancing and high availability configurations

For production deployments with Let's Encrypt certificates, you can modify the Nginx configuration to use certificates obtained via Certbot or other Let's Encrypt clients. You would need to:

1. Update the `nginx.conf` file to reference the Let's Encrypt certificate paths
2. Set up a cron job or systemd timer to automatically renew certificates
3. Ensure proper file permissions for the certificates
4. Configure DNS to point your domain to the server

Example Nginx configuration for Let's Encrypt certificates:
```nginx
ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
```
