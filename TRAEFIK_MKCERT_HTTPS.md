# Using Traefik and mkcert for HTTPS Access

This document describes how to configure HTTPS access for the Atlassian DC MCP service using Traefik and mkcert.

## Overview

[mkcert](https://github.com/FiloSottile/mkcert) is a simple tool for local HTTPS development that can create locally trusted development certificates. Combined with Traefik reverse proxy, we can provide HTTPS access for the MCP service.

## Prerequisites

1. Install Docker and Docker Compose
2. Install the mkcert tool

## Installing mkcert

### macOS (using Homebrew)

```bash
brew install mkcert
brew install nss # if using Firefox browser
```

### Linux

#### Ubuntu/Debian (using apt)

On Ubuntu/Debian systems, you can install mkcert directly using apt:

```bash
sudo apt update
sudo apt install mkcert
```

#### Other Linux distributions

On other Linux distributions, you need to install the mkcert binary manually:

```bash
# Download the latest version of mkcert
wget https://github.com/FiloSottile/mkcert/releases/download/v1.4.4/mkcert-v1.4.4-linux-amd64
chmod +x mkcert-v1.4.4-linux-amd64
sudo mv mkcert-v1.4.4-linux-amd64 /usr/local/bin/mkcert
```

## Create Local CA and Generate Certificates

1. Install the local CA:

```bash
mkcert -install
```

This will install the local CA in the system, making all certificates generated by mkcert trusted.

2. Create the certs folder in the project directory:

```bash
mkdir -p ./certs
cd ./certs
```

3. Generate local development certificates:

```bash
mkcert localhost 127.0.0.1 ::1
```

This will generate two files:
- `localhost+2.pem` (certificate file)
- `localhost+2-key.pem` (private key file)

## Configuring Traefik

The project includes Traefik configuration files in the [traefik-config/](traefik-config/) directory:

1. [traefik-config/traefik.yml](traefik-config/traefik.yml) - Main Traefik configuration
2. [traefik-config/certs.yml](traefik-config/certs.yml) - Certificate configuration

Traefik is configured to:
- Listen on port 443 for HTTPS requests
- Use the mkcert certificates
- Handle both regular HTTP requests and SSE streams
- Communicate with the MCP server using HTTP/2

## Starting the Service

Use the following commands to start the service with Traefik:

```bash
# Build and start the service
docker-compose -f docker-compose.traefik.yml up -d

# View logs
docker-compose -f docker-compose.traefik.yml logs -f
```

## Verifying the Configuration

After starting the service, you can access the MCP service through the following URLs:

- HTTPS: https://localhost/sse
- Traefik Dashboard: http://localhost:8080 (accessible only from the host machine)

## Configuring AI Assistant

When configuring the MCP service in your AI assistant, use the following configuration:

```json
{
  "mcpServers": {
    "atlassian-dc-mcp-sse": {
      "url": "https://localhost/sse",
      "headers": {
        "Jira-Token": "your-jira-api-token",
        "Confluence-Token": "your-confluence-api-token",
        "Bitbucket-Token": "your-bitbucket-api-token"
      }
    }
  }
}
```

## Production Environment Deployment

For production deployments with automatic SSL certificates from Let's Encrypt, use the following setup:

1. Update the domain name in `docker-compose.traefik-prod.yml`
   - Replace `your-domain.com` with your actual domain in the service labels
2. Update the email address in `traefik-config/traefik-prod.yml` 
   - Replace `your-email@example.com` with your email for Let's Encrypt registration
3. Ensure your DNS is properly configured to point to your server
4. Run with:

```bash
docker-compose -f docker-compose.traefik-prod.yml up -d
```

This setup will automatically:
- Obtain SSL certificates from Let's Encrypt
- Renew certificates automatically
- Redirect HTTP traffic to HTTPS
- Provide secure access to your MCP service

## Troubleshooting

### Certificate Not Trusted

If the browser still indicates that the certificate is not trusted, make sure:

1. You have correctly run `mkcert -install`
2. Restart your browser
3. On Linux, you may need to manually install the certificate in the system or browser

### Port Conflicts

If ports 80 or 443 are already in use, you can modify the port mapping in [docker-compose.traefik.yml](docker-compose.traefik.yml):

```yaml
ports:
  - "8080:80"
  - "8443:443"
```

Then access the service via https://localhost:8443.

### Cannot Connect to MCP Service

Check the following:

1. Is the MCP service running correctly: `docker-compose -f docker-compose.traefik.yml logs mcp-server`
2. Is the Traefik configuration correct: `docker-compose -f docker-compose.traefik.yml logs traefik-proxy`
3. Is the network connection normal: Ensure both containers are on the same network

## Production Environment Considerations

This configuration is only suitable for development and testing environments. In production environments, you should:

1. Use valid SSL certificates (such as Let's Encrypt)
2. Configure appropriate firewall rules
3. Strengthen Traefik security configuration
4. Use appropriate load balancing and high availability configurations
5. Replace `--api.insecure=true` with proper authentication in production
6. Use a valid email address for Let's Encrypt certificate registration
